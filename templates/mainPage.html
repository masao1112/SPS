<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Smart Planting System</title>
        <link rel="stylesheet" href="/static/styling.css">
        <link rel="stylesheet" href="/static/frontend.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    </head>

    <body>
        <header class="shadow p-3 mb-5 bg-white rounded">
            <div class="head-container d-flex justify-content-start">
                <img id="logo" src="/static/plant.png">
                <p id="title" style="display: inline-block">Smart Planting System</p>
            </div>
        </header>

        <main>
            <div id="container">
                <nav id="left">
                   <div class="d-flex flex-column bd-highlight mb-3">
                        <div class="left-hand-menu">
                            <div class="list">Home</div>
                        </div>   
                        <div class="left-hand-menu"> 
                            <div class="list">Current Data</div>
                        </div>
                        <div class="left-hand-menu">
                            <div class="list">Historical Data</div>
                        </div>    
                        <div class="left-hand-menu">
                            <div class="list">Feature Extraction</div>
                        </div>    
                        <div class="left-hand-menu">
                            <div class="list">Garden Assistant</div>
                        </div>    
                    </div> 
                </nav>

                <div id="right">
                    <section>
                        <h2>Home Page</h2>
                        <p>This is the home page</p>
                    </section>

                    <section>
                        <h2>Current Data</h2>
                        <p>This is the realtime data</p>
                        <div class="chart-container">
                            
                        </div>
                    </section>

                    <section class="historical-data">
                        <h2>Historical Data</h2>
                        <p>This is the historical data</p>
                        <div class="chart-container">
                            <canvas id="myTempChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="myHumidChart"></canvas>
                        </div>
                    </section>

                    <section>
                        <h2>Feature Extraction</h2>
                        <p>This is the feature extraction</p>
                    </section>

                    <section>
                        <h2>Garden Assistant</h2>
                        <p>This is the garden assistant</p>
                        <div class="slider-container">
                            <input type="range" min="1" max="100" class="slider" id="mySlider" oninput="fetchUserInput()" name="threshold">
                            <button id="updateButton" onclick="updateData()">Submit</button>
                        </div>
                        <div>
                            <p id="myValue"></p>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <footer>
            <p>2025 This is Smart Planting System</p>
        </footer>
        
    </body>

    <!-- Fetch Data using xml -->
    <script>
        function fetchData() {
            const xml = new XMLHttpRequest();
            xml.open('GET', 'http://127.0.0.1:5000/data/mongo', true);

            xml.responseType = 'json';
            xml.onload = function() {
                if (xml.status != 200) {
                    alert(`Error ${xml.status}: ${xml.statusText}`);
                }else {
                    let response = xml.response;
                    let lastValue = response[response.length-1];
                    let latestTempValue = lastValue['temp'];
                    let latestHumidValue = lastValue['humid'];

                    //Fetch latest 20docs
                    endIndex = response.length
                    startIndex = response.length-21;
                    latestTempList = [];
                    latestHumidList = [];
                    labels = [];
                    if(endIndex > 20) {
                        for(let i = startIndex; i < endIndex; i++) {
                            latestTempList.push(response[i]['temp']);
                            latestHumidList.push(response[i]['humid']);
                            labels.push(ISOParser(response[i].date['$date']));
                        }
                    }

                    //ISO1806 String parser
                    function ISOParser(isoString) {
                        let ISODate = new Date(isoString)
                        let year = ISODate.getFullYear();
                        let month = String(ISODate.getMonth()<8 ? '0' + ISODate.getMonth() : ISODate.getMonth());
                        let day = String(ISODate.getDate()<8 ? '0' + ISODate.getDate() : ISODate.getDate());
                        let hour = String(ISODate.getUTCHours()).padStart(2, "0");
                        let minute = String(ISODate.getUTCMinutes()).padStart(2, "0");
                        let second = String(ISODate.getUTCSeconds()).padStart(2, "0");
                        let date = `${year}-${month}-${day}`;
                        let time = `${hour}-${minute}-${second}`; 
                        return time;
                    }
                    
                    // Convert ISO1806 time format to DD-MM-YYYY:hh-mm-ss
                    function takeTime() {
                        let isoString = lastValue.date['$date']
                        let ISODate = new Date(isoString)
                        let year = ISODate.getFullYear();
                        let month = String(ISODate.getMonth()<8 ? '0' + ISODate.getMonth() : ISODate.getMonth());
                        let day = String(ISODate.getDate()<8 ? '0' + ISODate.getDate() : ISODate.getDate());
                        let hour = String(ISODate.getUTCHours()).padStart(2, "0");
                        let minute = String(ISODate.getUTCMinutes()).padStart(2, "0");
                        let second = String(ISODate.getUTCSeconds()).padStart(2, "0");
                        let date = `${year}-${month}-${day}`;
                        let time = `${hour}-${minute}-${second}`; 
                        console.log(lastValue)
                        return time;
                    }

                    /*
                    *Chart for visualization
                    */
                    // If chart already exists
                    if (window.tempChart) {
                        // Update data
                        window.tempChart.data.datasets[0].data.push(latestTempValue);
                        window.tempChart.data.labels.push(takeTime());

                        // Remove old data if exceeding 20 points
                        if (window.tempChart.data.labels.length > 20) {
                            // Temp chart
                            window.tempChart.data.labels.shift();
                            window.tempChart.data.datasets.forEach(dataset => dataset.data.shift());
                        }
                        window.tempChart.update();
                    } else {
                        // Create Chart if it doesn't exist
                        // Temp chart
                        var chartOne = document.getElementById('myTempChart');
                        window.tempChart = new Chart(chartOne, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{ 
                                    label: 'Current Temperature', 
                                    data: latestTempList, 
                                    borderWidth: 1,
                                    borderColor: 'rgb(227, 94, 32)',
                                }]
                            },
                            options: { 
                                responsive: true,
                                plugins: {
                                    legend: {
                                        labels: {
                                            // This more specific font property overrides the global property
                                            font: {
                                                size: 20
                                            }
                                        },
                                    }
                                }
                            }
                        });
                    }

                    if (window.humidChart) {
                        // Update data
                        window.humidChart.data.datasets[0].data.push(latestHumidValue);
                        window.humidChart.data.labels.push(takeTime());

                        // Remove old data if exceeding 20 points
                        if (window.humidChart.data.labels.length > 20) {
                            // Humid chart
                            window.humidChart.data.labels.shift();
                            window.humidChart.data.datasets.forEach(dataset => dataset.data.shift());
                        }
                        window.humidChart.update();
                    } else {
                        // Create Chart if it doesn't exist
                        // Humid chart
                        var chartTwo = document.getElementById('myHumidChart');
                        window.humidChart = new Chart(chartTwo, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{ 
                                    label: 'Current Humidity', 
                                    data: latestHumidList, 
                                    borderWidth: 1,
                                }]
                            },
                            options: { 
                                responsive: true, 
                                plugins: {
                                    legend: {
                                        labels: {
                                            // This more specific font property overrides the global property
                                            font: {
                                                size: 20
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }

                }
            }
            xml.send(); 
        }       
        setInterval(fetchData, 5000);
        fetchData();
    </script>


    <!-- Webapp to Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyCc2zXkyRKfHavz6B_ATJnjFepSu9vY0lY",
        authDomain: "sensor-data-6f9b0.firebaseapp.com",
        databaseURL: "https://sensor-data-6f9b0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sensor-data-6f9b0",
        storageBucket: "sensor-data-6f9b0.firebasestorage.app",
        messagingSenderId: "187832822335",
        appId: "1:187832822335:web:c3b7f6ecaf996a4f38a68a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import { getDatabase, ref, get, child, set, update, remove } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

        // Database deplayment
        const db = getDatabase();
        // Get DOM elements
        let thresholdValue = document.getElementById('mySlider').value;
        let updateButton = document.getElementById('updateButton');

        // Get threshold value when open
        get(ref(db, '/threshold/moisture')).then(childData => {
            if (childData.exists()){
                thresholdValue = childData.val();
                console.log("Successfully get data: " + thresholdValue)
            }
        }).catch(() => {
            console.log(error);
        }) 

        // Update threshold via user input
        function updateData() {
            thresholdValue = document.getElementById('mySlider').value;
            update(ref(db, '/threshold'), {
                moisture: parseInt(thresholdValue)
            }).then(() => {
                alert("Threshold adjusted Succesfully!!")
            }).catch(() => {
                alert('Cannot adjust the threshold.')
                console.log(error);
            })
        }    

        window.updateData = updateData;
    </script>

    <!-- Slider value on Screen -->
    <script>
        var userInput = document.getElementById("mySlider");
        var valueOnScreen = document.getElementById("myValue");
        if (localStorage.getItem("rangeValue")) {
                userInput.value = localStorage.getItem("rangeValue");
                valueOnScreen.innerHTML = `Moisture Threshold ${userInput.value}`;
            }
        //Function on input
        function fetchUserInput() {
            localStorage.setItem("rangeValue", userInput.value);
            valueOnScreen.innerHTML = `Moisture Threshold ${userInput.value}`;
            console.log(JSON.stringify({"user input": userInput.value}));
        }
        
    </script>

</html>