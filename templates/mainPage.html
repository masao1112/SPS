<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Smart Planting System</title>
        <link rel="stylesheet" href="/static/styling.css">
        <link rel="stylesheet" href="/static/frontend.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"></script>
    </head>

    <body>
        <header>
            <div id="logo">
                <p>"LOGO img" Smart Planting System</p>
            </div>
            <hr>
        </header>

        <main>
            <div id="container">
                <nav id="left">
                   <ul>
                        <div>
                            <li class="list">Home</li>
                        </div>   
                        <div>
                            <li class="list">Current Data</li>
                        </div>    
                        <div>
                            <li class="list">Historical Data</li>
                        </div>    
                        <div>
                            <li class="list">Feature Extraction</li>
                        </div>    
                        <div>
                            <li class="list">Garden Assistant</li>
                        </div>    
                   </ul> 
                </nav>

                <div id="right">
                    <section>
                        <h2>Home Page</h2>
                        <p>This is the home page</p>
                    </section>

                    <section>
                        <h2>Current Data</h2>
                        <p>This is the realtime data</p>
                    </section>

                    <section>
                        <h2>Historical Data</h2>
                        <p>This is the historical data</p>
                        <div class="chart-container">
                            <canvas id="myChart"></canvas>
                        </div>
                    </section>

                    <section>
                        <h2>Feature Extraction</h2>
                        <p>This is the feature extraction</p>
                    </section>

                    <section>
                        <h2>Garden Assistant</h2>
                        <p>This is the garden assistant</p>
                        <div class="slider-container">
                            <input type="range" min="1" max="100" class="slider" id="mySlider" oninput="fetchUserInput()" name="threshold">
                            <button id="updateButton" onclick="updateData()">Submit</button>
                        </div>
                        <div>
                            <p id="myValue"></p>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <footer>
            <p>2025 This is Smart Planting System</p>
        </footer>
        
    </body>

    <script>
        function fetchData() {
            const xml = new XMLHttpRequest();
            xml.open('GET', 'http://127.0.0.1:5000/data/mongo', true);

            xml.responseType = 'json';
            xml.onload = function() {
                if (xml.status != 200) {
                    alert(`Error ${xml.status}: ${xml.statusText}`);
                }else {
                    let response = xml.response;
                    let lastValue = response[response.length-1];
                    let temp = lastValue['temp'];
                    let humid = lastValue['humid'];
                    
                    //Date to String
                    function takeTime() {
                        response = xml.response;
                        lastValue = response[response.length-1]
                        let isoString = lastValue.date['$date']
                        let ISODate = new Date(isoString)
                        let year = ISODate.getFullYear();
                        let month = String(ISODate.getMonth()<8 ? '0' + ISODate.getMonth() : ISODate.getMonth());
                        let day = String(ISODate.getDate()<8 ? '0' + ISODate.getDate() : ISODate.getDate());
                        let hour = String(ISODate.getUTCHours()).padStart(2, "0");
                        let minute = String(ISODate.getUTCMinutes()).padStart(2, "0");
                        let second = String(ISODate.getUTCSeconds()).padStart(2, "0");
                        let date = `${year}-${month}-${day}`;
                        let time = `${hour}-${minute}-${second}`; 
                        console.log(lastValue)
                        return time;
                    }
                    if (window.chart) {
                        window.chart.data.datasets[0].data.push(temp);
                        window.chart.data.datasets[1].data.push(humid);
                        window.chart.data.labels.push(takeTime());

                        // Remove old data if exceeding 5 points
                        if (window.chart.data.labels.length > 5) {
                            window.chart.data.labels.shift();
                            window.chart.data.datasets.forEach(dataset => dataset.data.shift());
                        }

                        window.chart.update();
                    } else {
                        // Create Chart if it doesn't exist
                        var ctx = document.getElementById('myChart');
                        window.chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: [takeTime()],
                                datasets: [
                                    { label: 'Current Temperature', data: [temp], borderWidth: 1 },
                                    { label: 'Current Humidity', data: [humid], borderWidth: 1 }
                                ]
                            },
                            options: { responsive: true }
                        });
                    }
                }
            }
            xml.send(); 
        }       
        setInterval(fetchData, 5000);
        fetchData();
    </script>


    <!-- Webapp to Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyCc2zXkyRKfHavz6B_ATJnjFepSu9vY0lY",
        authDomain: "sensor-data-6f9b0.firebaseapp.com",
        databaseURL: "https://sensor-data-6f9b0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sensor-data-6f9b0",
        storageBucket: "sensor-data-6f9b0.firebasestorage.app",
        messagingSenderId: "187832822335",
        appId: "1:187832822335:web:c3b7f6ecaf996a4f38a68a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import { getDatabase, ref, get, child, set, update, remove } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

        // Database deplayment
        const db = getDatabase();
        // Get DOM elements
        let thresholdValue = document.getElementById('mySlider').value;
        let updateButton = document.getElementById('updateButton');

        // Get threshold value when open
        get(ref(db, '/threshold/moisture')).then(childData => {
            if (childData.exists()){
                thresholdValue = childData.val();
                console.log("Successfully get data: " + thresholdValue)
            }
        }).catch(() => {
            console.log(error);
        }) 

        // Update threshold via user input
        function updateData() {
            thresholdValue = document.getElementById('mySlider').value;
            update(ref(db, '/threshold'), {
                moisture: parseInt(thresholdValue)
            }).then(() => {
                alert("Threshold adjusted Succesfully!!")
            }).catch(() => {
                alert('Cannot adjust the threshold.')
                console.log(error);
            })
        }    

        window.updateData = updateData;
    </script>

    <!-- Slider value on Screen -->
    <script>
        var userInput = document.getElementById("mySlider");
        var valueOnScreen = document.getElementById("myValue");
        if (localStorage.getItem("rangeValue")) {
                userInput.value = localStorage.getItem("rangeValue");
                valueOnScreen.innerHTML = `Moisture Threshold ${userInput.value}`;
            }
        //Function on input
        function fetchUserInput() {
            localStorage.setItem("rangeValue", userInput.value);
            valueOnScreen.innerHTML = `Moisture Threshold ${userInput.value}`;
            console.log(JSON.stringify({"user input": userInput.value}));
        }
        
    </script>

</html>